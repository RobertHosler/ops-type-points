<div *ngIf="routerInit && !initialLoad">
  <div #container class="container pt-3 mb-5">
    <div *ngIf="false" class="img-right img-heading">
      <img src="/assets/images/database.png" />
    </div>
    <div *ngIf="!searchInitiated" class="search-top">
      <h1>
        <span class="search-heading">Search the </span
        ><span class="sp-branding">Database</span>
      </h1>
      <div>
        <p class="lead">
          <strong>{{ recordCount }}</strong> people typed in the
          <strong>Objective Personality System</strong>,
          <strong>Enneagram</strong>, and <strong>Socionics</strong>. Try
          entering a type, a name, or scroll down to see more advanced tricks.
        </p>
      </div>
      <div class="d-none d-sm-flex my-2" *ngIf="false">
        <app-type-indicator [option]="1"></app-type-indicator>
        <div class="mx-3">
          <app-type-indicator
            [option]="1"
            type="MF-Fe/Ni-BP/C(S)"
          ></app-type-indicator>
        </div>
        <div class="mx-3">
          <app-type-indicator
            [option]="1"
            type="FM-Fi/Se-CS/B(P)"
          ></app-type-indicator>
        </div>
        <div class="mx-3">
          <app-type-indicator
            [option]="1"
            type="FF-Ti/Ni-SB/P(C)"
          ></app-type-indicator>
        </div>
      </div>
    </div>
    <div class="clear-right"></div>
    <div class="my-3">
      <div class="form-group">
        <!-- <label for="name" class="name-label">Search by Name or Type:</label> -->
        <div class="input-group">
          <input
            #nameInput
            id="name"
            type="text"
            class="form-control border-primary"
            minlength="2"
            required
            autocomplete="off"
            [placeholder]="placeholderText"
            (keyup)="searchAll()"
            [(ngModel)]="textString"
            name="name"
          />
          <div class="input-group-append">
            <button class="btn btn-outline-primary" (click)="clearSearch()">
              Clear
            </button>
          </div>
        </div>
        <div class="help small mb-3" *ngIf="false">
          Searches for the text within the name and types field of the person
          record. Examples:
          <a [routerLink]="['/search']" [queryParams]="{ text: 'john cena' }"
            >john cena</a
          >,
          <a [routerLink]="['/search']" [queryParams]="{ text: 'sp/so - 6w7' }"
            >sp/so - 6w7</a
          >,
          <a [routerLink]="['/search']" [queryParams]="{ text: 'ff-ti/se' }"
            >ff-ti/se</a
          >
        </div>
      </div>
      <div *ngIf="false">
        <div class="mb-3">
          <span class="search-type-label">Additional Search Options</span>
          <div>
            <button
              *ngFor="let st of searchToggles"
              class="btn btn-gray mr-2"
              (click)="toggleSearchOptions(st.name)"
              [ngClass]="{ active: st.active }"
            >
              {{ st.name }}
            </button>
          </div>
        </div>
        <div [ngClass]="{ 'd-none': !enneaToggle.active }">
          <ng-component *ngTemplateOutlet="ennea"></ng-component>
        </div>
        <div [ngClass]="{ 'd-none': !opsToggle.active }">
          <ng-component *ngTemplateOutlet="ops"></ng-component>
        </div>
      </div>
      <div class="button-wrapper" *ngIf="searchInitiated">
        <div class="d-inline-block">
          <div class="small">Sort:</div>
          <div class="btn-group">
            <button
              class="btn btn-gray btn-sm"
              [ngClass]="{ active: sortBy === 'name' }"
              (click)="resort('name')"
            >
              Name
            </button>
            <button
              class="btn btn-gray btn-sm"
              [ngClass]="{ active: sortBy === 'ops' }"
              (click)="resort('ops')"
            >
              OPS
            </button>
            <button
              class="btn btn-gray btn-sm"
              [ngClass]="{ active: sortBy === 'ennea' }"
              (click)="resort('ennea')"
            >
              Ennea
            </button>
            <button
              class="btn btn-gray btn-sm"
              [ngClass]="{ active: sortBy === 'modified' }"
              (click)="resort('modified')"
            >
              Recent
            </button>
          </div>
        </div>
        <div class="d-inline-block">
          <div class="small">Color:</div>
          <div class="btn-group">
            <button
              class="btn btn-gray btn-sm"
              [ngClass]="{ active: grayscale }"
              (click)="grayscale = !grayscale"
            >
              Gray
            </button>
            <button
              class="btn btn-gray btn-sm"
              [ngClass]="{ active: !grayscale }"
              (click)="grayscale = !grayscale"
            >
              Default
            </button>
          </div>
        </div>
        <div class="d-inline-block">
          <div class="small">Display:</div>
          <div class="btn-group">
            <button
              class="btn btn-gray btn-sm"
              [ngClass]="{ active: cards }"
              (click)="cards = !cards"
            >
              Cards
            </button>
            <button
              class="btn btn-gray btn-sm"
              [ngClass]="{ active: !cards }"
              (click)="cards = !cards"
            >
              Default
            </button>
          </div>
        </div>
        <div class="d-inline-block">
          <button
            class="btn btn-gray btn-sm"
            [ngClass]="{ active: showHelp }"
            (click)="showHelp = !showHelp"
          >
            Help
          </button>
        </div>
      </div>
      <div *ngIf="showHelp" class="mt-2">
        <ng-component *ngTemplateOutlet="tips"></ng-component>
      </div>
      <div class="mt-2" *ngIf="searches.size > 0">
        <div>Previous Searches</div>
        <div class="previous-search-wrapper">
          <span
            *ngFor="let previousSearch of searches | keyvalue"
            class="previous-search"
          >
            <a
              [routerLink]="['/search']"
              [queryParams]="{ text: previousSearch.key }"
              >{{ previousSearch.value.term }} ({{
                previousSearch.value.count
              }})</a
            >
            <button (click)="searches.delete(previousSearch.key)">X</button>
          </span>
          <button
            *ngIf="searches.size > 4"
            (click)="searches.clear()"
            class="previous-search previous-search-clear"
          >
            Clear All
          </button>
        </div>
      </div>
    </div>
    <p
      *ngIf="displayedRecords && displayedRecords.length > 0"
      class="text-info"
    >
      Search found {{ displayedRecords.length }} results.
    </p>
  </div>

  <div class="search-instructions" *ngIf="!searchInitiated">
    <div class="fix-bg bg-light-gray">
      <div class="container">
        <h2>Objective Personality</h2>
        <h3>Search by...</h3>
        <div class="rules">
          <div class="rule" *ngFor="let rule of searchModel.opsRules">
            <div class="rule-name">{{ rule.label }}</div>
            <div class="rule-example">
              <ng-container
                *ngFor="let example of rule.examples; let i = index"
              >
                <span class="mx-1" *ngIf="i > 0"></span>
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: example }"
                ></ng-container>
              </ng-container>
            </div>
          </div>
        </div>
        <div class="my-2">
          Any of the above search terms can be combined together for advanced
          search.
          <div>
            <span class="mx-3 d-inline-block"
              ><ng-container
                *ngTemplateOutlet="
                  searchlink;
                  context: { text: 'MM ENTP Jumper' }
                "
              ></ng-container
            ></span>
            <span class="mx-3 d-inline-block"
              ><ng-container
                *ngTemplateOutlet="searchlink; context: { text: 'xF ENFJ pc' }"
              ></ng-container
            ></span>
            <span class="mx-3 d-inline-block"
              ><ng-container
                *ngTemplateOutlet="
                  searchlink;
                  context: { text: 'intp female ff' }
                "
              ></ng-container
            ></span>
          </div>
        </div>
        <div>
          <app-ops-type-table></app-ops-type-table>
        </div>
      </div>
    </div>
    <div class="fix-bg e-bg bg-light-gray">
      <div class="container">
        <h2>Enneagram</h2>
        <div class="mb-3">
          <h3>Search by...</h3>
          <div class="rules">
            <div class="rule">
              <div class="rule-name">All Enneagram</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: 'ennea' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Core Type</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: '9' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">with Wing</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: '6w7' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Primary Instinct</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: 'sp/' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Playground Instinct</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: '/sx' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Blindspot Instinct</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: '!so' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Instinct not blind</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: 'so' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Instinct Stacking</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: 'sx/sp' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div
                class="rule-name"
                popoverTitle="Trifix Stacking"
                popover="Order matters for the trifix stacking search. 369 will not return 963 results."
                triggers="mouseenter:mouseleave:click"
              >
                Trifix Stacking
                <i-bs
                  name="info-circle"
                  class="ml-1"
                  width=".8rem"
                  height=".8rem"
                ></i-bs>
              </div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: '396' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div
                class="rule-name"
                popoverTitle="Trifix Combinations"
                popover="Order doesn't matter for the trifix combination search.  *369 and *936 will return the same results."
                triggers="mouseenter:mouseleave:click"
              >
                Trifix Combinations
                <i-bs
                  name="info-circle"
                  class="ml-1"
                  width=".8rem"
                  height=".8rem"
                ></i-bs>
              </div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: '*714' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Sex</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="
                    searchlink;
                    context: { text: '5w6 female' }
                  "
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Combine Searches</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: '9w8 !sp' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Ennea + OPS</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: 'sp MM' }"
                ></ng-container>
              </div>
            </div>
            <div class="rule">
              <div class="rule-name">Ennea + Socionics</div>
              <div class="rule-example">
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: 'so EIE' }"
                ></ng-container>
              </div>
            </div>
          </div>
        </div>
        <h3>Trifix Combinations</h3>
        <div class="fix-wrapper">
          <table class="trifix-table ej-red">
            <tbody>
              <tr *ngFor="let x of [0, 1, 2]">
                <td
                  *ngFor="
                    let fix of searchModel.trifixStacks.slice(x * 3, x * 3 + 3);
                    let i = index
                  "
                >
                  <a
                    [routerLink]="['/search']"
                    [queryParams]="{ text: '*' + fix }"
                    >{{ fix }}</a
                  >
                </td>
              </tr>
            </tbody>
          </table>
          <table class="trifix-table ij-blue">
            <tbody>
              <tr *ngFor="let x of [3, 4, 5]">
                <td
                  *ngFor="
                    let fix of searchModel.trifixStacks.slice(x * 3, x * 3 + 3);
                    let i = index
                  "
                >
                  <a
                    [routerLink]="['/search']"
                    [queryParams]="{ text: '*' + fix }"
                    >{{ fix }}</a
                  >
                </td>
              </tr>
            </tbody>
          </table>
          <table class="trifix-table ep-green">
            <tbody>
              <tr *ngFor="let x of [6, 7, 8]">
                <td
                  *ngFor="
                    let fix of searchModel.trifixStacks.slice(x * 3, x * 3 + 3);
                    let i = index
                  "
                >
                  <a
                    [routerLink]="['/search']"
                    [queryParams]="{ text: '*' + fix }"
                    >{{ fix }}</a
                  >
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="fix-bg bg-light-gray">
      <div class="container">
        <h2>Socionics</h2>
        <h3>Search by...</h3>
        <div class="rules">
          <div class="rule" *ngFor="let rule of searchModel.wssRules">
            <div class="rule-name">{{ rule.label }}</div>
            <div class="rule-example">
              <ng-container
                *ngFor="let example of rule.examples; let i = index"
              >
                <span class="mx-1" *ngIf="i > 0"></span>
                <ng-container
                  *ngTemplateOutlet="searchlink; context: { text: example }"
                ></ng-container>
              </ng-container>
            </div>
          </div>
        </div>
        <div class="mt-3 fix-wrapper">
          <div
            *ngFor="
              let quadra of ['Alpha', 'Beta', 'Gamma', 'Delta'];
              let x = index
            "
          >
            <table class="trifix-table">
              <thead>
                <tr>
                  <th colspan="2">
                    <div class="text-center">{{ quadra }}</div>
                  </th>
                </tr>
              </thead>
              <tbody
                [ngClass]="{
                  'ej-red': quadra === 'Alpha',
                  'ij-blue': quadra === 'Beta',
                  'ep-green': quadra === 'Gamma',
                  'ip-gray': quadra === 'Delta'
                }"
              >
                <tr>
                  <td
                    *ngFor="
                      let type of searchModel.socionicsTypes.slice(
                        x * 2,
                        x * 2 + 2
                      );
                      let i = index
                    "
                  >
                    <a
                      [routerLink]="['/search']"
                      [queryParams]="{ text: type }"
                      >{{ type.toUpperCase() }}</a
                    >
                  </td>
                </tr>
                <tr>
                  <td
                    *ngFor="
                      let type of searchModel.socionicsTypes.slice(
                        x * 2 + 2,
                        x * 2 + 4
                      );
                      let i = index
                    "
                  >
                    <a
                      [routerLink]="['/search']"
                      [queryParams]="{ text: type }"
                      >{{ type.toUpperCase() }}</a
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="record-wrapper">
    <div *ngIf="searchInitiated" class="container-fluid records-bg" #recordList>
      <app-type-record-list
        [typeRecords]="displayedRecords"
        [loading]="searchLoading"
        [linkToAnalyzer]="true"
        [grayscale]="grayscale"
        [cards]="cards"
      ></app-type-record-list>
    </div>
  </div>
</div>

<ng-template #ops>
  <div class="search-coins mb-5">
    <div class="row">
      <div class="col-md-4">
        <div *ngIf="options" class="coin-groups">
          <div *ngFor="let option of optionValues">
            <div class="coin-label coin-label-sm" *ngIf="false">
              <a
                [href]="option.coin.infoLink"
                target="_blank"
                *ngIf="option.coin.infoLink"
              >
                {{ option.coin.name }}
              </a>
              <span *ngIf="!option.coin.infoLink">
                {{ option.coin.name }}
              </span>
            </div>
            <div class="btn-group" btnRadioGroup [(ngModel)]="option.val">
              <ng-container
                *ngIf="option.coin.sides.length === 2; else other_content"
              >
                <label
                  class="btn btn-side"
                  [btnRadio]="option.coin.sides[0].val"
                >
                  {{ option.coin.sides[0].name }}
                </label>
                <label class="btn btn-middle" [btnRadio]="''"> / </label>
                <label
                  class="btn btn-side"
                  [btnRadio]="option.coin.sides[1].val"
                >
                  {{ option.coin.sides[1].name }}
                </label>
              </ng-container>
              <ng-template #other_content>
                <label
                  class="btn"
                  [btnRadio]="side.val"
                  *ngFor="let side of option.coin.sides"
                >
                  {{ side.name }}
                </label>
                <label class="btn btn-unset" [btnRadio]="''"> Clear </label>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 d-md-none">
        <hr />
      </div>
      <div class="col-md-8">
        <div *ngFor="let cluster of clusters">
          <span class="coin-label d-none">{{ cluster.name }}</span>
          <div class="coin-groups">
            <div class="btn-group">
              <label
                class="btn"
                *ngFor="let funct of cluster.cluster"
                [ngClass]="{ active: isCoins(funct.coins) }"
                (click)="setCoins(funct.coins)"
              >
                {{ funct.label }}
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #ennea>
  <div class="search-coins search-enneagram mb-5">
    <div class="search-ewrapper mb-3">
      <div class="search-etype mr-3">
        <label class="type-label">Type</label>
        <span *ngFor="let eType of eTypes; let i = index">
          <button
            class="btn btn-gray mx-1 my-1"
            [ngClass]="{ active: activeEType === eType }"
            (click)="toggleEType(eType)"
          >
            {{ eType.name }}
          </button>
          <br *ngIf="(i + 1) % 3 === 0"
        /></span>
      </div>
      <div class="search-wing mr-3">
        <label class="type-label">Wing</label>
        <div *ngIf="activeEType">
          <button
            *ngFor="let wing of activeEType.wings"
            class="btn btn-gray mx-1"
            [ngClass]="{ active: activeWing === wing }"
            (click)="
              activeWing === wing ? (activeWing = null) : (activeWing = wing)
            "
          >
            {{ wing }}
          </button>
        </div>
        <div *ngIf="!activeEType">
          <button class="btn btn-gray mx-1" *ngFor="let x of [1, 2]">?</button>
        </div>
      </div>
      <div class="search-instinct mr-3">
        <label class="type-label">Instinct</label>
        <button
          *ngFor="let instinct of instincts"
          class="btn btn-gray mx-1"
          [ngClass]="{ active: activeInstinct === instinct }"
          (click)="toggleInstinct(instinct)"
        >
          {{ instinct.name }}
        </button>
      </div>
      <div class="search-instinct2">
        <label class="type-label">Second Instinct</label>
        <div *ngIf="activeInstinct">
          <button
            *ngFor="let second of activeInstinct.secondary"
            class="btn btn-gray mx-1"
            [ngClass]="{ active: activeInstinct2 === second }"
            (click)="
              activeInstinct2 === second
                ? (activeInstinct2 = null)
                : (activeInstinct2 = second)
            "
          >
            {{ second }}
          </button>
        </div>
        <div *ngIf="!activeInstinct">
          <button class="btn btn-gray mx-1" *ngFor="let x of [1, 2]">?</button>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #tips>
  <ul class="search-tips">
    <li>
      <a [routerLink]="['/search']" [queryParams]="{ text: 'Kardashian' }"
        >Looking for a specific person? Search by name, Ex: "Kardashian"</a
      >
    </li>
    <li>
      <a [routerLink]="['/search']" [queryParams]="{ text: 'mm exxj fe' }">
        Want to see those of a similar type? Search by parts. Ex: "mm exxj
        fe"</a
      >
    </li>
    <li>
      <a [routerLink]="['/search']" [queryParams]="{ text: 'ennea' }">
        Only want to see those with an Enneagram type? Add "Ennea" or
        "Enneagram" to your search.</a
      >
    </li>
    <li>
      Just try some things out! If you find a keyword isn't working as you might
      expect,
      <a [href]="appLinks.contact" target="_blank">let me know!</a>
    </li>
  </ul>
</ng-template>

<ng-template #searchlink let-text="text">
  <a [routerLink]="['/search']" [queryParams]="{ text: text }">{{ text }}</a>
</ng-template>
